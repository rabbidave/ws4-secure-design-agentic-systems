# Zero-Trust Tool Invocation - CoSAI-RM Schema
# Version: 1.2.0

metadata:
  name: zero-trust-tool-invocation
  version: "1.2.0"
  status: draft
  framework_mappings:
    - cosai-rm
    - mitre-atlas
    - owasp-llm-top10
    - nist-ai-rmf
    - stride

invariants:
  - id: INV-1
    name: Identity-Tool Binding
    assertion: "token.sub == user.id AND token.tool == request.tool"
    description: Token binds specific identity to specific tool
    tier: 1
    required: true
    
  - id: INV-2
    name: Temporal Validity
    assertion: "now() < token.exp AND now() >= token.nbf"
    description: Authorization valid only within defined temporal window
    tier: 1
    required: true
    default_ttl_seconds: 30
    
  - id: INV-3
    name: Parameter Integrity
    assertion: "sha256(actualParams) == token.parameters_hash"
    description: Hash of executed parameters must equal hash bound in token
    tier: 1
    required: true
    critical: true  # Differentiator from traditional OAuth
    
  - id: INV-4
    name: Atomic Consumption
    assertion: "atomicStore.compareAndSet(jti, null, 'consumed')"
    description: Authorization token consumable exactly once
    tier: 1
    required: true
    
  - id: INV-5
    name: Transport Binding (DPoP)
    assertion: "verify(dpopProof) AND sha256(token) == ath"
    description: Binds token to TLS session via proof-of-possession
    tier: 2
    required: false
    
  - id: INV-6
    name: Client Signature (Enhanced)
    assertion: "verify(invocationSignature, clientPublicKey)"
    description: Client pre-signs complete invocation for non-repudiation
    tier: 3
    required: false

hash_provenance:
  description: Hash may originate client-side or server-side
  modes:
    - id: ad-hoc
      description: Client-generated at user approval (MCP model)
    - id: pre-defined
      description: Server-generated at mandate definition (AP2 model)
    - id: hybrid
      description: Server schema + client values

components:
  - id: COMP-01
    name: Identity Provider
    description: OAuth 2.x / OIDC issuer
    security_role: Authenticates WHO
    
  - id: COMP-02
    name: Authorization Service
    description: Token generation with parameter binding
    security_role: Binds WHAT to WHO
    
  - id: COMP-03
    name: Atomic State Store
    description: Redis, etcd, DynamoDB with atomic operations
    security_role: Enforces single-use (AXIOM-2)
    
  - id: COMP-04
    name: Validation Gateway
    description: Hash verification, temporal checks
    security_role: Enforces AXIOM-1, AXIOM-3, AXIOM-4
    
  - id: COMP-05
    name: Tool Endpoint
    description: Target execution environment
    security_role: Executes only validated requests

risks:
  - id: RISK-01
    name: Parameter Tampering
    atlas_id: AML.T0048
    owasp_llm: LLM04
    stride: Tampering
    description: Agent or MITM modifies parameters between approval and execution
    control: INV-3
    
  - id: RISK-02
    name: Replay Attack
    atlas_id: AML.T0040
    stride: Spoofing
    description: Captured token reused for unauthorized execution
    controls: [INV-4, INV-2]
    
  - id: RISK-03
    name: Agent Misinterpretation
    owasp_llm: LLM04
    description: LLM regenerates different parameters than user intended
    control: INV-3
    
  - id: RISK-04
    name: Privilege Escalation
    stride: Elevation of Privilege
    description: Token used for unintended tool or scope
    control: INV-1
    
  - id: RISK-05
    name: Session Hijacking
    atlas_id: AML.T0024
    stride: Spoofing
    description: Long-lived token stolen and misused
    controls: [INV-2, INV-5]

controls:
  - id: CTRL-01
    name: Identity-Tool Validation
    implements: INV-1
    tier: 1
    description: Verify token.sub and token.tool match request
    
  - id: CTRL-02
    name: Temporal Validation
    implements: INV-2
    tier: 1
    description: Verify token within validity window
    
  - id: CTRL-03
    name: Hash Binding
    implements: INV-3
    tier: 1
    description: Validate sha256(request.params) == token.parameters_hash
    critical: true
    
  - id: CTRL-04
    name: Atomic JTI Consumption
    implements: INV-4
    tier: 1
    description: Single-use token via atomic store operation
    
  - id: CTRL-05
    name: DPoP Transport Binding
    implements: INV-5
    tier: 2
    description: Bind token to TLS session via proof-of-possession
    optional: true
    
  - id: CTRL-06
    name: Client Pre-Signing
    implements: INV-6
    tier: 3
    description: Client signs complete invocation
    optional: true

tiers:
  - level: 1
    name: Minimum Viable
    classification: [4, 5]
    required_invariants: [INV-1, INV-2, INV-3, INV-4]
    
  - level: 2
    name: Enhanced
    classification: [2, 3]
    required_invariants: [INV-1, INV-2, INV-3, INV-4, INV-5]
    
  - level: 3
    name: Maximum
    classification: [1]
    required_invariants: [INV-1, INV-2, INV-3, INV-4, INV-5, INV-6]

validation_sequence:
  - step: 1
    action: VERIFY token signature
  - step: 2
    action: ASSERT token.sub == authenticated_user.id
    invariant: INV-1
  - step: 3
    action: ASSERT token.tool == requested_tool
    invariant: INV-1
  - step: 4
    action: ASSERT now() < token.exp AND now() >= token.nbf
    invariant: INV-2
  - step: 5
    action: ASSERT sha256(request.params) == token.parameters_hash
    invariant: INV-3
    critical: true
  - step: 6
    action: ASSERT atomicStore.compareAndSet(jti, null, "consumed")
    invariant: INV-4
  - step: 7
    action: IF dpop_present THEN verify(dpopProof) AND sha256(token) == ath
    invariant: INV-5
    optional: true
  - step: 8
    action: IF signature_present THEN verify(invocationSignature, clientPublicKey)
    invariant: INV-6
    optional: true
  - step: 9
    action: EXECUTE tool(params)
  - step: 10
    action: LOG transaction

framework_mappings:
  mitre_atlas:
    - id: AML.T0024
      name: Session Hijacking
      risks: [RISK-05]
    - id: AML.T0040
      name: Replay Attack
      risks: [RISK-02]
    - id: AML.T0048
      name: Data Manipulation
      risks: [RISK-01]
      
  owasp_llm_top10:
    - id: LLM04
      name: Model Denial of Service / Prompt Injection
      risks: [RISK-01, RISK-03]
    - id: LLM06
      name: Sensitive Information Disclosure
      controls: [CTRL-01]
    - id: LLM08
      name: Excessive Agency
      controls: [CTRL-04]
      
  stride:
    - category: Spoofing
      risks: [RISK-02, RISK-05]
    - category: Tampering
      risks: [RISK-01]
    - category: Repudiation
      controls: [CTRL-06]
    - category: Elevation of Privilege
      risks: [RISK-04]
